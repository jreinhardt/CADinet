THREE.TrackballControls=function(E,D){var u=this;var v={NONE:-1,ROTATE:0,ZOOM:1,PAN:2,TOUCH_ROTATE:3,TOUCH_ZOOM_PAN:4};this.object=E;this.domElement=(D!==undefined)?D:document;this.enabled=true;this.screen={left:0,top:0,width:0,height:0};this.rotateSpeed=1;this.zoomSpeed=1.2;this.panSpeed=0.3;this.noRotate=false;this.noZoom=false;this.noPan=false;this.noRoll=false;this.staticMoving=false;this.dynamicDampingFactor=0.2;this.minDistance=0;this.maxDistance=Infinity;this.keys=[65,83,68];this.target=new THREE.Vector3();var m=0.000001;var l=new THREE.Vector3();var w=v.NONE,p=v.NONE,b=new THREE.Vector3(),s=new THREE.Vector3(),k=new THREE.Vector3(),n=new THREE.Vector2(),z=new THREE.Vector2(),j=0,d=0,e=new THREE.Vector2(),y=new THREE.Vector2();this.target0=this.target.clone();this.position0=this.object.position.clone();this.up0=this.object.up.clone();var C={type:"change"};var o={type:"start"};var i={type:"end"};this.handleResize=function(){if(this.domElement===document){this.screen.left=0;this.screen.top=0;this.screen.width=window.innerWidth;this.screen.height=window.innerHeight}else{var F=this.domElement.getBoundingClientRect();var G=this.domElement.ownerDocument.documentElement;this.screen.left=F.left+window.pageXOffset-G.clientLeft;this.screen.top=F.top+window.pageYOffset-G.clientTop;this.screen.width=F.width;this.screen.height=F.height}};this.handleEvent=function(F){if(typeof this[F.type]=="function"){this[F.type](F)}};var c=(function(){var F=new THREE.Vector2();return function(H,G){F.set((H-u.screen.left)/u.screen.width,(G-u.screen.top)/u.screen.height);return F}}());var a=(function(){var G=new THREE.Vector3();var F=new THREE.Vector3();var H=new THREE.Vector3();return function(J,I){H.set((J-u.screen.width*0.5-u.screen.left)/(u.screen.width*0.5),(u.screen.height*0.5+u.screen.top-I)/(u.screen.height*0.5),0);var K=H.length();if(u.noRoll){if(K<Math.SQRT1_2){H.z=Math.sqrt(1-K*K)}else{H.z=0.5/K}}else{if(K>1){H.normalize()}else{H.z=Math.sqrt(1-K*K)}}b.copy(u.object.position).sub(u.target);G.copy(u.object.up).setLength(H.y);G.add(F.copy(u.object.up).cross(b).setLength(H.x));G.add(b.setLength(H.z));return G}}());this.rotateCamera=(function(){var F=new THREE.Vector3(),G=new THREE.Quaternion();return function(){var H=Math.acos(s.dot(k)/s.length()/k.length());if(H){F.crossVectors(s,k).normalize();H*=u.rotateSpeed;G.setFromAxisAngle(F,-H);b.applyQuaternion(G);u.object.up.applyQuaternion(G);k.applyQuaternion(G);if(u.staticMoving){s.copy(k)}else{G.setFromAxisAngle(F,H*(u.dynamicDampingFactor-1));s.applyQuaternion(G)}}}}());this.zoomCamera=function(){if(w===v.TOUCH_ZOOM_PAN){var F=j/d;j=d;b.multiplyScalar(F)}else{var F=1+(z.y-n.y)*u.zoomSpeed;if(F!==1&&F>0){b.multiplyScalar(F);if(u.staticMoving){n.copy(z)}else{n.y+=(z.y-n.y)*this.dynamicDampingFactor}}}};this.panCamera=(function(){var G=new THREE.Vector2(),F=new THREE.Vector3(),H=new THREE.Vector3();return function(){G.copy(y).sub(e);if(G.lengthSq()){G.multiplyScalar(b.length()*u.panSpeed);H.copy(b).cross(u.object.up).setLength(G.x);H.add(F.copy(u.object.up).setLength(G.y));u.object.position.add(H);u.target.add(H);if(u.staticMoving){e.copy(y)}else{e.add(G.subVectors(y,e).multiplyScalar(u.dynamicDampingFactor))}}}}());this.checkDistances=function(){if(!u.noZoom||!u.noPan){if(b.lengthSq()>u.maxDistance*u.maxDistance){u.object.position.addVectors(u.target,b.setLength(u.maxDistance))}if(b.lengthSq()<u.minDistance*u.minDistance){u.object.position.addVectors(u.target,b.setLength(u.minDistance))}}};this.update=function(){b.subVectors(u.object.position,u.target);if(!u.noRotate){u.rotateCamera()}if(!u.noZoom){u.zoomCamera()}if(!u.noPan){u.panCamera()}u.object.position.addVectors(u.target,b);u.checkDistances();u.object.lookAt(u.target);if(l.distanceToSquared(u.object.position)>m){u.dispatchEvent(C);l.copy(u.object.position)}};this.reset=function(){w=v.NONE;p=v.NONE;u.target.copy(u.target0);u.object.position.copy(u.position0);u.object.up.copy(u.up0);b.subVectors(u.object.position,u.target);u.object.lookAt(u.target);u.dispatchEvent(C);l.copy(u.object.position)};function h(F){if(u.enabled===false){return}window.removeEventListener("keydown",h);p=w;if(w!==v.NONE){return}else{if(F.keyCode===u.keys[v.ROTATE]&&!u.noRotate){w=v.ROTATE}else{if(F.keyCode===u.keys[v.ZOOM]&&!u.noZoom){w=v.ZOOM}else{if(F.keyCode===u.keys[v.PAN]&&!u.noPan){w=v.PAN}}}}}function f(F){if(u.enabled===false){return}w=p;window.addEventListener("keydown",h,false)}function r(F){if(u.enabled===false){return}F.preventDefault();F.stopPropagation();if(w===v.NONE){w=F.button}if(w===v.ROTATE&&!u.noRotate){s.copy(a(F.pageX,F.pageY));k.copy(s)}else{if(w===v.ZOOM&&!u.noZoom){n.copy(c(F.pageX,F.pageY));z.copy(n)}else{if(w===v.PAN&&!u.noPan){e.copy(c(F.pageX,F.pageY));y.copy(e)}}}document.addEventListener("mousemove",A,false);document.addEventListener("mouseup",t,false);u.dispatchEvent(o)}function A(F){if(u.enabled===false){return}F.preventDefault();F.stopPropagation();if(w===v.ROTATE&&!u.noRotate){k.copy(a(F.pageX,F.pageY))}else{if(w===v.ZOOM&&!u.noZoom){z.copy(c(F.pageX,F.pageY))}else{if(w===v.PAN&&!u.noPan){y.copy(c(F.pageX,F.pageY))}}}}function t(F){if(u.enabled===false){return}F.preventDefault();F.stopPropagation();w=v.NONE;document.removeEventListener("mousemove",A);document.removeEventListener("mouseup",t);u.dispatchEvent(i)}function q(F){if(u.enabled===false){return}F.preventDefault();F.stopPropagation();var G=0;if(F.wheelDelta){G=F.wheelDelta/40}else{if(F.detail){G=-F.detail/3}}n.y+=G*0.01;u.dispatchEvent(o);u.dispatchEvent(i)}function x(I){if(u.enabled===false){return}switch(I.touches.length){case 1:w=v.TOUCH_ROTATE;s.copy(a(I.touches[0].pageX,I.touches[0].pageY));k.copy(s);break;case 2:w=v.TOUCH_ZOOM_PAN;var H=I.touches[0].pageX-I.touches[1].pageX;var G=I.touches[0].pageY-I.touches[1].pageY;d=j=Math.sqrt(H*H+G*G);var F=(I.touches[0].pageX+I.touches[1].pageX)/2;var J=(I.touches[0].pageY+I.touches[1].pageY)/2;e.copy(c(F,J));y.copy(e);break;default:w=v.NONE}u.dispatchEvent(o)}function g(I){if(u.enabled===false){return}I.preventDefault();I.stopPropagation();switch(I.touches.length){case 1:k.copy(a(I.touches[0].pageX,I.touches[0].pageY));break;case 2:var H=I.touches[0].pageX-I.touches[1].pageX;var G=I.touches[0].pageY-I.touches[1].pageY;d=Math.sqrt(H*H+G*G);var F=(I.touches[0].pageX+I.touches[1].pageX)/2;var J=(I.touches[0].pageY+I.touches[1].pageY)/2;y.copy(c(F,J));break;default:w=v.NONE}}function B(G){if(u.enabled===false){return}switch(G.touches.length){case 1:k.copy(a(G.touches[0].pageX,G.touches[0].pageY));s.copy(k);break;case 2:j=d=0;var F=(G.touches[0].pageX+G.touches[1].pageX)/2;var H=(G.touches[0].pageY+G.touches[1].pageY)/2;y.copy(c(F,H));e.copy(y);break}w=v.NONE;u.dispatchEvent(i)}this.domElement.addEventListener("contextmenu",function(F){F.preventDefault()},false);this.domElement.addEventListener("mousedown",r,false);this.domElement.addEventListener("mousewheel",q,false);this.domElement.addEventListener("DOMMouseScroll",q,false);this.domElement.addEventListener("touchstart",x,false);this.domElement.addEventListener("touchend",B,false);this.domElement.addEventListener("touchmove",g,false);window.addEventListener("keydown",h,false);window.addEventListener("keyup",f,false);this.handleResize();this.update()};THREE.TrackballControls.prototype=Object.create(THREE.EventDispatcher.prototype);